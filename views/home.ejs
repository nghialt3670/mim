<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/styles.css">
  <title>Mim</title>
</head>
<body>
  <script>
    function adjustTime(utcTimeString) {
      const utcTime = new Date(utcTimeString);
      const userTimeZoneOffset = new Date().getTimezoneOffset();
      const localTime = new Date(utcTime.getTime() - userTimeZoneOffset * 60000);
      
      // You can customize the time format as needed
      return localTime.toLocaleString();
    }
  </script>
  <div id="sidebar">
    <div id="user-navigation">
      <a href="/profile/<%= user.username %>">My Profile</a>
      <a href="/liked-post">Liked Meme</a>
      <a href="/post-upload">Upload Meme</a>
      <a href="/logout">Log Out</a>
    </div>
  </div>
  <div id="newsfeed">
    <button id="sidebar-toggle-btn" onclick="toggleSidebar()">=</button>  
    <div class="post-list">
      <% if (posts) { %>
        <ul>
          <% posts.forEach(post => { %>
            <li id="<%= post.id %>" class="post">
              <div class="avatar-username">
                <img class="avatar" src="<%= post.avatar ? 'data:' + post.imageContentType + ';base64,' + (post.avatar.data ? post.avatar.data.toString('base64') : '') : '' %>" alt="Avatar">
                <div class="username-container">
                  <a href="/profile/<%= post.author%>" class="username"><%= post.author %></a>
                  <div class="time">
                    <%
                      function adjustTime(utcTimeString) {
                        const utcTime = new Date(utcTimeString);
                        const currentTime = new Date();
                        const timeDifference = currentTime - utcTime;

                        // Convert milliseconds to seconds
                        const seconds = Math.floor(timeDifference / 1000);

                        if (seconds < 60) {
                          return seconds === 1 ? "1 second ago" : seconds + " seconds ago";
                        } else if (seconds < 3600) {
                          const minutes = Math.floor(seconds / 60);
                          return minutes === 1 ? "1 minute ago" : minutes + " minutes ago";
                        } else if (seconds < 86400) {
                          const hours = Math.floor(seconds / 3600);
                          return hours === 1 ? "1 hour ago" : hours + " hours ago";
                        } else if (seconds < 2592000) {
                          const days = Math.floor(seconds / 86400);
                          return days === 1 ? "1 day ago" : days + " days ago";
                        } else if (seconds < 31536000) {
                          const months = Math.floor(seconds / 2592000);
                          return months === 1 ? "1 month ago" : months + " months ago";
                        } else {
                          const years = Math.floor(seconds / 31536000);
                          return years === 1 ? "1 year ago" : years + " years ago";
                        }
                      }
                    %>
                    <%= adjustTime(post.timeCreate) %>
                  </div>
                </div>
              </div>
              <p id="caption"><%= post.caption %></p>
              <img id="image" class="image" src="data:<%= post.image.contentType %>;base64,<%= post.image.data.toString('base64') %>" alt="Image">
              <div id="like">
                  <button id="like-btn" onclick="handleLike('<%= post.id %>', '<%= user.username %>')">
                    <% if (post.liked) { %>
                      <div>&#128514</div>
                    <% } else { %>
                      <div>&#128528</div>
                    <% } %>
                  </button>
                  <div class="likes-container">
                    <div>(</div>
                    <div id="num-likes"><%= post.numLikes %></div>
                    <div>&nbsp;haha)</div>
                    <div id="haha-emoji" class="no-display">&#128528</div>
                  </div>
              </div>
            </li>
          <% }) %> 
        </ul>
      <% } %>
    </div>
  </div>
	<script>
    function setTime() {
      const currentTime = new Date();
      document.getElementById('timeCreate').value = currentTime.toISOString();
    }

    function toggleSidebar() {
      var sidebar = document.getElementById('sidebar');
      var newsfeed = document.getElementById('newsfeed');

      if (sidebar.style.left === "-3px") {
        sidebar.style.left = "-303px";
        newsfeed.style.marginLeft = "0";
      } else {
        sidebar.style.left = "-3px";
        newsfeed.style.marginLeft = "300px";
      }
    }

    function setNumLikes(postId) {
      var likedPost = document.getElementById(postId);
      var likeButton = likedPost.querySelector('#like-btn');
      var numLikesEntity = likedPost.querySelector('#num-likes');
      var emoji = likeButton.querySelector("div");
      var numLikes = numLikesEntity.innerHTML;
      var newLikeCount;

      if (emoji.innerHTML === document.getElementById('haha-emoji').innerHTML) {
        newLikeCount = Number(numLikes) + 1;
        emoji.innerHTML = '&#128514'
      } else {
        newLikeCount = Number(numLikes) - 1;
        emoji.innerHTML = '&#128528'
      }
      numLikesEntity.innerHTML = newLikeCount;
    }

    function handleLike(postId, username) {
      setNumLikes(postId)

      fetch('/update-like', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ postId: postId }),
      });
    }
  </script>
</body>
</html>
